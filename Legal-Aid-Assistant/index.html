<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Legal Aid Assistant ‚Äî Frontend</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>üáÆüá≥ AI Legal Aid Assistant</header>

  <div class="container">
    <label>Select Language</label>
    <select id="language">
        <option value="en">English</option>
        <option value="hi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
        <option value="kn">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
        <option value="te">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
        <option value="ta">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
        <option value="mr">Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
        <option value="gu">Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
        <option value="bn">Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
        <option value="ml">Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
        <option value="pa">Punjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
        <option value="or">Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)</option>
    </select>

    <label>Describe your legal issue</label>
    <textarea id="userQuery" rows="5" placeholder="Type your question in your selected language..."></textarea>

    <button class="mic-btn" id="micBtn" title="Speak">üé§</button>

    <label>Upload Document / Image (photo of papers, FIR, land doc)</label>
    <input type="file" id="uploadImage" accept="image/*,application/pdf" multiple>

    <label>Enable Voice Assistant</label>
    <select id="voiceOption">
      <option value="off">Off</option>
      <option value="on">On</option>
    </select>

    <div class="actions">
      <button id="sendBtn">Ask Lawyer AI</button>
      <button id="clearBtn" class="muted">Clear</button>
    </div>

    <div id="responseBox" aria-live="polite"></div>
    <div id="uploadsPreview" class="preview"></div>
  </div>

<script>
/* ----------------------
   Speech-to-text (microphone)
   ---------------------- */
const micBtn = document.getElementById('micBtn');
const queryBox = document.getElementById('userQuery');
let recognition = null;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'hi-IN'; // default; will change based on selector
  recognition.onstart = () => micBtn.classList.add('active');
  recognition.onend = () => micBtn.classList.remove('active');
  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript;
    // append to any existing content to allow multi-turn input
    queryBox.value = queryBox.value ? (queryBox.value + ' ' + text) : text;
  };
} else {
  micBtn.title = 'Voice input not supported by this browser';
  micBtn.style.opacity = '0.6';
}

micBtn.addEventListener('click', () => {
  if (!recognition) { 
    alert('Voice input not supported on this browser. Use Chrome/Edge on desktop or Android.'); 
    return; 
  }
  const lang = document.getElementById('language').value;
  
  // Map language codes to speech recognition codes
  // Note: Browser support varies - Chrome/Edge support more languages
  const langMap = {
    'en': 'en-IN',
    'hi': 'hi-IN',
    'kn': 'kn-IN',
    'te': 'te-IN',
    'ta': 'ta-IN',
    'mr': 'mr-IN',
    'gu': 'gu-IN',
    'bn': 'bn-IN',
    'ml': 'ml-IN',
    'pa': 'pa-IN',
    'or': 'or-IN'
  };
  
  const recognitionLang = langMap[lang] || 'en-IN';
  
  // Stop any ongoing recognition first
  try {
    recognition.stop();
  } catch (e) {}
  
  // Set language BEFORE starting
  recognition.lang = recognitionLang;
  
  // Small delay to ensure language is set
  setTimeout(() => {
    try { 
      recognition.start(); 
      console.log('Voice recognition started with language:', recognitionLang);
    } catch (e) { 
      if (e.message && e.message.includes('already')) {
        // If already started, stop and restart
        recognition.stop();
        setTimeout(() => recognition.start(), 100);
      } else {
        console.error('Recognition error:', e);
        alert('Could not start voice recognition. Please try again or type your question.');
      }
    }
  }, 100);
});
/* ----------------------
   Preview uploaded files
   ---------------------- */
const uploadInput = document.getElementById('uploadImage');
const uploadsPreview = document.getElementById('uploadsPreview');

uploadInput.addEventListener('change', () => {
  uploadsPreview.innerHTML = '';
  Array.from(uploadInput.files).forEach((file, i) => {
    const div = document.createElement('div');
    div.className = 'file-item';
    const name = document.createElement('div');
    name.textContent = `${file.name} (${Math.round(file.size/1024)} KB)`;
    div.appendChild(name);
    uploadsPreview.appendChild(div);
  });
});

/* ----------------------
   Send data to backend
   ---------------------- */
const sendBtn = document.getElementById('sendBtn');
const responseBox = document.getElementById('responseBox');
const voiceOption = document.getElementById('voiceOption');
const clearBtn = document.getElementById('clearBtn');

clearBtn.addEventListener('click', () => {
  queryBox.value = '';
  uploadInput.value = '';
  uploadsPreview.innerHTML = '';
  responseBox.style.display = 'none';
  responseBox.innerHTML = '';
});

sendBtn.addEventListener('click', sendQuery);

// ... existing code ...

async function sendQuery() {
  const question = queryBox.value.trim();
  const language = document.getElementById('language').value;
  const voice = voiceOption.value;

  if (!question) {
    alert('Please enter your legal issue.');
    return;
  }

  responseBox.style.display = 'block';
  responseBox.innerHTML = '<div class="muted">‚è≥ Processing ‚Äî please wait...</div>';

  try {
    const res = await fetch('http://127.0.0.1:8000/ask', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_query: question,
        language: language
      })
    });

    if (!res.ok) throw new Error('Server error ' + res.status);
    const data = await res.json();

    // Check for errors
    if (data.error) {
      responseBox.innerHTML = `<div class="error">‚ö†Ô∏è Error: ${escapeHtml(data.error)}</div>`;
      return;
    }

    // Show response (backend returns both 'reply' and 'answer')
    const answer = data.reply || data.answer || 'No response received.';
    responseBox.innerHTML = `<div class="answer-title">AI Assistant says:</div><div class="answer-text">${escapeHtml(answer)}</div>`;

    // Speak if enabled
    // Speak if enabled
    if (voice === 'on' && 'speechSynthesis' in window) {
      const utter = new SpeechSynthesisUtterance(answer);
      const langMap = {
        'en': 'en-IN',
        'hi': 'hi-IN',
        'kn': 'kn-IN',
        'te': 'te-IN',
        'ta': 'ta-IN',
        'mr': 'mr-IN',
        'gu': 'gu-IN',
        'bn': 'bn-IN',
        'ml': 'ml-IN',
        'pa': 'pa-IN',
        'or': 'or-IN'
      };
      utter.lang = langMap[language] || 'en-IN';
      utter.rate = 0.95;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }
  } catch (err) {
    responseBox.innerHTML = `<div class="error">‚ö†Ô∏è Error: ${escapeHtml(err.message)}. Make sure the backend server is running on http://127.0.0.1:8000</div>`;
  }
}

// ... existing code ...
// small helper to escape HTML when injecting text
function escapeHtml(str) {
  if (!str) return '';
  return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

</script>
</body>
</html>